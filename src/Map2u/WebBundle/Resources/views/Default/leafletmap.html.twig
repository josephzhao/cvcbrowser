<html>
    <head>
        <title>Leaflet WMS GetFeatureInfo Example</title>
        <meta charset="utf-8" />
{# empty Twig template #}
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.4.5/leaflet.css" />
        <!--[if lte IE 8]>
            <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.4.5/leaflet.ie.css" />
        <![endif]-->
        <style type="text/css">
            .leaflet-popup-content {
                /*margin: 14px 20px;*/
                overflow: scroll;
                /*maxWidth: 400;*/
            }
        </style>
    </head>
    <body>
        <div id="map" style="width: 600px; height: 400px"></div>
        <form name="checkform"><input type="checkbox" name="getfeatureinfo" value="checked" checked="checked" onClick="DoTheCheck()"/> WMS Get Feature Info</form>

        <script src="http://cdn.leafletjs.com/leaflet-0.4.5/leaflet.js"></script>
        <script src="http://code.jquery.com/jquery-1.8.1.min.js"></script>
        <script>
            //var map = new L.Map('map');
            var map, popup;
            var nexrad = new L.TileLayer.WMS("http://map.neighbourhood123.com:8080/geoserver/manifold/wms", {
                layers: 'manifold:manifold_geoms',
                format: 'image/png',
                transparent: true
            });

            map = new L.Map('map', {
                center: new L.LatLng(44.095475729465, -72.388916015626),
                zoom: 7,
                layers: [ nexrad],
                zoomControl: true
            });

            map.addEventListener('click', onMapClick);

            popup = new L.Popup({
                maxWidth: 400
            });


            popup = new L.Popup({
                maxWidth: 400
            });

            /*function onMapClick(e) {
             var latlngStr = '(' + e.latlng.lat.toFixed(3) + ', ' + e.latlng.lng.toFixed(3) + ')';
             var BBOX = map.getBounds()._southWest.lng+","+map.getBounds()._southWest.lat+","+map.getBounds()._northEast.lng+","+map.getBounds()._northEast.lat;
             var WIDTH = map.getSize().x;
             var HEIGHT = map.getSize().y;
             var X = map.layerPointToContainerPoint(e.layerPoint).x;
             var Y = map.layerPointToContainerPoint(e.layerPoint).y;
             var URL = 'http://suite.opengeo.org/geoserver/usa/wms?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetFeatureInfo&LAYERS=usa:states&QUERY_LAYERS=usa:states&STYLES=&BBOX='+BBOX+'&FEATURE_COUNT=5&HEIGHT='+HEIGHT+'&WIDTH='+WIDTH+'&FORMAT=image%2Fpng&INFO_FORMAT=text%2Fhtml&SRS=EPSG%3A4326&X='+X+'&Y='+Y;
             //alert(URL);
             popup.setLatLng(e.latlng);
             popup.setContent("<iframe src='"+URL+"' width='300' height='100' frameborder='0'><p>Your browser does not support iframes.</p></iframe>");
             map.openPopup(popup);
             
             }*/

            function onMapClick(e) {
                var latlngStr = '(' + e.latlng.lat.toFixed(3) + ', ' + e.latlng.lng.toFixed(3) + ')';
                var BBOX = map.getBounds().toBBoxString();
                var WIDTH = map.getSize().x;
                var HEIGHT = map.getSize().y;
                var X = map.layerPointToContainerPoint(e.layerPoint).x;
                var Y = map.layerPointToContainerPoint(e.layerPoint).y;
                var URL = '?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetFeatureInfo&LAYERS=usa:states&QUERY_LAYERS=usa:states&STYLES=&BBOX=' + BBOX + '&FEATURE_COUNT=5&HEIGHT=' + HEIGHT + '&WIDTH=' + WIDTH + '&FORMAT=image%2Fpng&INFO_FORMAT=text%2Fhtml&SRS=EPSG%3A4326&X=' + X + '&Y=' + Y;
                URL = escape(URL);
                $.ajax({
                    url: "wms_proxy.php?&args=" + URL,
                    dataType: "html",
                    type: "GET",
                    //async: false,
                    success: function(data) {
                        if (data.indexOf("<table") != -1) {
                            popup.setContent(data);
                            popup.setLatLng(e.latlng);
                            map.openPopup(popup);

                            // dork with the default return table - get rid of geoserver fid column, apply bootstrap table styling
                            /*if ($(".featureInfo th:nth-child(1)").text() == "fid") $('.featureInfo td:nth-child(1), .featureInfo th:nth-child(1)').hide();
                             $("caption.featureInfo").removeClass("featureInfo");
                             $("table.featureInfo").addClass("table").addClass("table-striped").addClass("table-condensed").addClass("table-hover").removeClass("featureInfo");*/
                        }
                    }
                });


            }

            function DoTheCheck() {
                if (document.checkform.getfeatureinfo.checked == true)
                {
                    map.addEventListener('click', onMapClick);
                }
                if (document.checkform.getfeatureinfo.checked == false)
                {
                    map.removeEventListener('click', onMapClick);
                    map.closePopup(popup);
                }
            }
        </script>
    </body>
</html>